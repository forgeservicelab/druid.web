<?php
/**
 * @file
 * Code for the FORGE WEB wizard feature.
 */

include_once 'forge_web_wizard.features.inc';

/**
 * 
 * Implements hook_form_alter 
 */
function forge_web_wizard_form_alter(&$form, &$form_state, $form_id) {
  /*
   * Replace [nid:xx] in webform markup type components
   */
  if(strstr($form_id, 'webform_client_form')) {
    drupal_add_js(drupal_get_path('module', 'forge_web_wizard').'/forge_web_wizard.js');
    foreach ($form['submitted'] as $key => $compo) {
      if (!empty($compo['#type']) && $compo['#type'] == 'fieldset') {
        // if component type is a fieldset lets loop again. 
        // TODO: maybe we need recursive function for this if there is fieldsets inside fieldsets
        if(is_array($compo)) {
          foreach ($compo as $sub_key => $sub_compo) {
            if(is_array($sub_compo)) {
              if (!empty($sub_compo['#type']) && $sub_compo['#type'] === 'markup' && strstr($sub_compo['#webform_component']['value'],'[nid:')) {
                $pattern = '/\[nid:([0-9][^|]*?)?\]/im';
                $callback = '_forge_web_wizard_embed_filter_replace';
                $replacement = preg_replace_callback($pattern, $callback, $sub_compo['#webform_component']['value']);
                if ($replacement) {
                  $form['submitted'][$key][$sub_key]['#markup'] = $replacement;
                }
              }
            }
          }
        }
      }
      // if component typeis markup and if there is [nid:xx] lets replace it
      elseif (!empty($compo['#type']) && $compo['#type'] == 'markup' && strstr($compo['#webform_component']['value'],'[nid:')) {
        $pattern = '/\[nid:([0-9][^|]*?)?\]/im';
        $callback = '_forge_web_wizard_embed_filter_replace';
        $replacement = preg_replace_callback($pattern, $callback, $compo['#webform_component']['value']);
        if($replacement) {
          $form['submitted'][$key]['#markup'] = $replacement;
        }
      }
    }
  }
}

/**
 * function converts [nid:xxx] with node summary and link to node
 * @param $match
 *   $match[1] contains the nid
 * @return
 *   String
 */
function _forge_web_wizard_embed_filter_replace($match) {
  if (is_numeric($match[1]) && $node = node_load($match[1])) {
    $body = field_get_items('node', $node, 'body');
    $summary = $body[0]['summary'];
    $summary .= '<p>'.l(t('Learn more'), 'node/'.$node->nid).'</p>';
    return $summary;
  }
  else {
    return t('Content not found. (ID:'.$match[1].')');
  }
}

/**
 * 
 * Implements hook_menu 
 */
function forge_web_wizard_menu() {
  $items['become-a-partner/confirmation/%/%'] = array(
    'page callback' => 'forge_web_wizard_confirmation',
    'page arguments' => array(2, 3),
    'access arguments' => array("access content"),
    'type' => MENU_CALLBACK,
    'title' => 'Confirmation',
  );
  
  return $items;
}

function forge_web_wizard_confirmation($nid, $sid) {
  $output = '';
  $pdf_id = '';
  // Get the submission array
  $submission = webform_menu_submission_load($sid, $nid);
  //dsm($submission);
  // 'role selection' is key 1
  if(!empty($submission->data[1][0])) {
    $value = $submission->data[1][0];
    $field_name = 'field_'.strtolower($value);
  }
  // 'I need cloud computing...' is key 11
  if(!empty($submission->data[2][0])) {
    $value = $submission->data[2][0];
    $cloud_computing_field_name = 'field_'.strtolower($value);
  }
  
  if(is_numeric($nid)) {
    $node = node_load($nid);
    //dsm($node);
    if(!empty($field_name)) {
      $field_values = field_get_items('node', $node, $field_name);
    }
    
    $pdf_id = $field_values[0]['value'];
    if(!empty($cloud_computing_field_name)) {
      //$cloud_computing_values = field_get_items('node', $node, $cloud_computing_field_name);
      $cloud_computing_pdf_id = $cloud_computing_values[0]['value'];
    }
  }
  
  if(!empty($cloud_computing_field_name)) {
    $cloud_computing_link = l(t('Download Cloud Computing contract'),  'fillpdf', array('query' => array('fid' => $cloud_computing_pdf_id, 'webform[nid]' => $nid, 'webform[sid]' => $sid)));
    $output = $cloud_computing_link.'<br/>';
  }
  $output .= l(t('Download Service Developer Contract'), 'fillpdf', array('query' => array('fid' => $pdf_id, 'webform[nid]' => $nid, 'webform[sid]' => $sid))); 
  return $output;
}

/**
 * Implements hook_fillpdf_merge_fields_alter_alter().
 * alter is twice because fillpdf has drupal_alter('fillpdf_merge_fields_alter' so we need two alters :)
 */
function forge_web_wizard_fillpdf_merge_fields_alter_alter(&$fields, $context) {
  /*
   * Mapped array:
   * array(
   *  'FIELD_KEY_FROM_WEBFORM' => 'FIELD NAME TO MAP IN PDF'
   *  'FIELD_KEY_FROM_WEBFORM' => array(
   *    'FIELD NAME TO MAP IN PDF 1'
   *    'FIELD NAME TO MAP IN PDF 2'
   *    ......
   * )
   */
  $mapped_fields = array(
    'parties_involved_business_id' => 'Business ID',
    'parties_involved_company_name' => array(
      'Organization name',
      'Signature name',
      'Developer name'
    )
  );
  foreach($mapped_fields as $field_key => $field_value) {
    $component_key = _forge_web_wizard_search_for_key($field_key, $context['webforms'][0]['webform']->webform['components']); 
    //dsm($context['webforms'][0]['submission']->wfm_data[$component_key]);
    $multiple_fields = _forge_web_wizard_recursive_array_search($component_key, $context['webforms'][0]['submission']->wfm_data[$component_key]);
    $i = 1;
    foreach ($multiple_fields as $key => $value) {
      if(is_array($field_value)) {
        foreach ($field_value as $sub_key => $sub_value) {
          $fields[$sub_value.' '.$i] = $value;
        }
      }
      else {
        $fields[$field_value.' '.$i] = $value;
      }
      $i++;
    }
  }
  
  /*
  if(!empty($context['webforms'][0]['submission']['wfm_data'])) {
    $wfm_data = $context['webforms'][0]['submission']['wfm_data'];
    //dsm();
  }
  */
}

/*
 * helper for hook_fillpdf_merge_fields_alter_alter()
 * Search key from given array
 */
function _forge_web_wizard_search_for_key($value, $array) {
  foreach ($array as $key => $val) {
    if ($val['form_key'] === $value) {
      return $key;
    }
  }
  return null;
}

/*
 * recursive helper
 * recursive walk throught array
 */
function _forge_web_wizard_recursive_array_search($needle, $haystack, $return_arr = array()) { 
  foreach($haystack as $key => $value) {
    if($needle === $key) {
      $return_arr[] = $haystack[$key][0];
    }
    if(is_array($value)){
      $return_arr = _forge_web_wizard_recursive_array_search($needle, $value, $return_arr);
    }
  }
  return $return_arr;
}